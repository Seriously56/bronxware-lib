local InputService = game:GetService('UserInputService');
local TextService = game:GetService('TextService');
local CoreGui = game:GetService('CoreGui');
local Teams = game:GetService('Teams');
local Players = game:GetService('Players');
local RunService = game:GetService('RunService')
local TweenService = game:GetService('TweenService');
local RenderStepped = RunService.RenderStepped;
local LocalPlayer = Players.LocalPlayer;
local Mouse = LocalPlayer:GetMouse();

local ProtectGui = protectgui or (syn and syn.protect_gui) or (function() end);

local ScreenGui = Instance.new('ScreenGui');
ProtectGui(ScreenGui);

ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global;
ScreenGui.Parent = CoreGui;

local Toggles = {};
local Options = {};

getgenv().Toggles = Toggles;
getgenv().Options = Options;

-- Custom 1-of-1 Visual Theme
local Library = {
    Registry = {};
    RegistryMap = {};
    HudRegistry = {};

    -- Premium color scheme
    FontColor = Color3.fromRGB(240, 240, 240);
    MainColor = Color3.fromRGB(15, 15, 20);
    BackgroundColor = Color3.fromRGB(10, 10, 15);
    AccentColor = Color3.fromRGB(0, 180, 255);
    SecondaryColor = Color3.fromRGB(120, 80, 255);
    OutlineColor = Color3.fromRGB(40, 40, 50);
    RiskColor = Color3.fromRGB(255, 80, 80);
    SuccessColor = Color3.fromRGB(80, 255, 140);

    Black = Color3.new(0, 0, 0);
    White = Color3.new(1, 1, 1);
    Font = Enum.Font.GothamBold;

    -- Custom properties
    CornerRadius = UDim.new(0, 6);
    GlowEnabled = true;
    AnimationsEnabled = true;
    BlurBackground = true;

    OpenedFrames = {};
    DependencyBoxes = {};

    Signals = {};
    ScreenGui = ScreenGui;
};

-- Enhanced Rainbow System with multiple modes
local RainbowStep = 0
local Hue = 0
Library.RainbowMode = "Smooth" -- "Smooth", "Pulse", "Wave"

table.insert(Library.Signals, RenderStepped:Connect(function(Delta)
    RainbowStep = RainbowStep + Delta

    if RainbowStep >= (1 / 60) then
        RainbowStep = 0
        Hue = Hue + (1 / 300);

        if Hue > 1 then
            Hue = 0;
        end;

        if Library.RainbowMode == "Pulse" then
            Library.CurrentRainbowHue = 0.5 + math.sin(Hue * math.pi * 2) * 0.3
        elseif Library.RainbowMode == "Wave" then
            Library.CurrentRainbowHue = (math.sin(Hue * math.pi * 4) + 1) / 2
        else
            Library.CurrentRainbowHue = Hue
        end

        Library.CurrentRainbowColor = Color3.fromHSV(Library.CurrentRainbowHue, 0.9, 1);
    end
end))

-- Custom rounded corners function
function Library:ApplyCorner(Instance)
    local Corner = Instance.new('UICorner')
    Corner.CornerRadius = Library.CornerRadius
    Corner.Parent = Instance
    return Corner
end

-- Enhanced glow effect
function Library:ApplyGlow(Instance, Intensity)
    if not Library.GlowEnabled then return end
    
    local Glow = Instance.new('ImageLabel')
    Glow.Name = "GlowEffect"
    Glow.Image = "rbxassetid://8992230675"
    Glow.ImageColor3 = Library.AccentColor
    Glow.ScaleType = Enum.ScaleType.Slice
    Glow.SliceCenter = Rect.new(100, 100, 100, 100)
    Glow.BackgroundTransparency = 1
    Glow.Size = UDim2.new(1, 20, 1, 20)
    Glow.Position = UDim2.new(0, -10, 0, -10)
    Glow.ImageTransparency = 0.8
    Glow.ZIndex = Instance.ZIndex - 1
    Glow.Parent = Instance
    
    Library:AddToRegistry(Glow, {
        ImageColor3 = 'AccentColor'
    })
    
    return Glow
end

-- Enhanced text with better styling
function Library:ApplyTextStroke(Inst)
    Inst.TextStrokeTransparency = 0.8
    Inst.TextStrokeColor3 = Color3.new(0, 0, 0)

    local Stroke = Instance.new('UIStroke')
    Stroke.Color = Color3.new(0, 0, 0)
    Stroke.Thickness = 2
    Stroke.LineJoinMode = Enum.LineJoinMode.Round
    Stroke.Parent = Inst
    
    return Stroke
end

-- Custom creation with enhanced styling
function Library:Create(Class, Properties)
    local _Instance = Instance.new(Class)

    for Property, Value in next, Properties do
        _Instance[Property] = Value
    end

    -- Auto-apply corners to frames
    if _Instance:IsA('Frame') or _Instance:IsA('ScrollingFrame') or _Instance:IsA('TextBox') then
        if not Properties.CornerRadius then
            Library:ApplyCorner(_Instance)
        end
    end

    return _Instance
end

-- Enhanced label creation
function Library:CreateLabel(Properties, IsHud)
    local _Instance = Library:Create('TextLabel', {
        BackgroundTransparency = 1;
        Font = Library.Font;
        TextColor3 = Library.FontColor;
        TextSize = 16;
        TextStrokeTransparency = 0.8;
        RichText = true;
    });

    Library:ApplyTextStroke(_Instance);

    Library:AddToRegistry(_Instance, {
        TextColor3 = 'FontColor';
    }, IsHud);

    -- Apply additional properties
    for Property, Value in next, Properties do
        _Instance[Property] = Value
    end

    return _Instance
end;

-- Enhanced draggable with smooth movement
function Library:MakeDraggable(Instance, Cutoff)
    Instance.Active = true;
    local DragTween = nil

    Instance.InputBegan:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton1 then
            local ObjPos = Vector2.new(
                Mouse.X - Instance.AbsolutePosition.X,
                Mouse.Y - Instance.AbsolutePosition.Y
            );

            if ObjPos.Y > (Cutoff or 40) then
                return;
            end;

            if DragTween then
                DragTween:Cancel()
            end

            while InputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) do
                local NewPos = UDim2.new(
                    0,
                    Mouse.X - ObjPos.X + (Instance.Size.X.Offset * Instance.AnchorPoint.X),
                    0,
                    Mouse.Y - ObjPos.Y + (Instance.Size.Y.Offset * Instance.AnchorPoint.Y)
                );

                if Library.AnimationsEnabled then
                    Instance.Position = NewPos
                else
                    Instance.Position = NewPos
                end

                RenderStepped:Wait();
            end;
        end;
    end)
end;

-- Enhanced tooltip with animations
function Library:AddToolTip(InfoStr, HoverInstance)
    local X, Y = Library:GetTextBounds(InfoStr, Library.Font, 14);
    local Tooltip = Library:Create('Frame', {
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.AccentColor,
        BorderSizePixel = 2,
        Size = UDim2.fromOffset(X + 16, Y + 12),
        ZIndex = 100,
        Parent = Library.ScreenGui,
        Visible = false,
    })

    Library:ApplyGlow(Tooltip, 0.3)

    local Label = Library:CreateLabel({
        Position = UDim2.fromOffset(8, 6),
        Size = UDim2.fromOffset(X, Y);
        TextSize = 14;
        Text = InfoStr,
        TextColor3 = Library.FontColor,
        TextXAlignment = Enum.TextXAlignment.Left;
        ZIndex = Tooltip.ZIndex + 1,
        Parent = Tooltip;
    });

    Library:AddToRegistry(Tooltip, {
        BackgroundColor3 = 'MainColor';
        BorderColor3 = 'AccentColor';
    });

    Library:AddToRegistry(Label, {
        TextColor3 = 'FontColor',
    });

    local IsHovering = false
    local HoverTween = nil

    HoverInstance.MouseEnter:Connect(function()
        if Library:MouseIsOverOpenedFrame() then
            return
        end

        IsHovering = true

        if HoverTween then
            HoverTween:Cancel()
        end

        Tooltip.Position = UDim2.fromOffset(Mouse.X + 15, Mouse.Y + 12)
        Tooltip.Visible = true
        Tooltip.Size = UDim2.fromOffset(0, Y + 12)

        if Library.AnimationsEnabled then
            HoverTween = TweenService:Create(Tooltip, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                Size = UDim2.fromOffset(X + 16, Y + 12)
            })
            HoverTween:Play()
        else
            Tooltip.Size = UDim2.fromOffset(X + 16, Y + 12)
        end

        while IsHovering do
            RunService.Heartbeat:Wait()
            Tooltip.Position = UDim2.fromOffset(Mouse.X + 15, Mouse.Y + 12)
        end
    end)

    HoverInstance.MouseLeave:Connect(function()
        IsHovering = false
        if HoverTween then
            HoverTween:Cancel()
        end
        
        if Library.AnimationsEnabled then
            local TweenOut = TweenService:Create(Tooltip, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                Size = UDim2.fromOffset(0, Y + 12)
            })
            TweenOut:Play()
            TweenOut.Completed:Connect(function()
                Tooltip.Visible = false
            end)
        else
            Tooltip.Visible = false
        end
    end)
end

-- Enhanced highlight with glow effects
function Library:OnHighlight(HighlightInstance, Instance, Properties, PropertiesDefault)
    local OriginalGlow = nil
    
    HighlightInstance.MouseEnter:Connect(function()
        local Reg = Library.RegistryMap[Instance];

        for Property, ColorIdx in next, Properties do
            Instance[Property] = Library[ColorIdx] or ColorIdx;

            if Reg and Reg.Properties[Property] then
                Reg.Properties[Property] = ColorIdx;
            end;
        end;

        -- Add glow effect
        if Library.GlowEnabled then
            OriginalGlow = Library:ApplyGlow(Instance, 0.4)
        end
    end)

    HighlightInstance.MouseLeave:Connect(function()
        local Reg = Library.RegistryMap[Instance];

        for Property, ColorIdx in next, PropertiesDefault do
            Instance[Property] = Library[ColorIdx] or ColorIdx;

            if Reg and Reg.Properties[Property] then
                Reg.Properties[Property] = ColorIdx;
            end;
        end;

        -- Remove glow effect
        if OriginalGlow then
            OriginalGlow:Destroy()
            OriginalGlow = nil
        end
    end)
end;

-- Add missing essential functions
function Library:SafeCallback(f, ...)
    if (not f) then
        return;
    end;

    if not Library.NotifyOnError then
        return f(...);
    end;

    local success, event = pcall(f, ...);

    if not success then
        local _, i = event:find(":%d+: ");

        if not i then
            return Library:Notify(event);
        end;

        return Library:Notify(event:sub(i + 1), 3);
    end;
end;

function Library:AttemptSave()
    if Library.SaveManager then
        Library.SaveManager:Save();
    end;
end;

function Library:GetTextBounds(Text, Font, Size, Resolution)
    local Bounds = TextService:GetTextSize(Text, Size, Font, Resolution or Vector2.new(1920, 1080))
    return Bounds.X, Bounds.Y
end;

function Library:GetDarkerColor(Color)
    local H, S, V = Color3.toHSV(Color);
    return Color3.fromHSV(H, S, V / 1.5);
end;

Library.AccentColorDark = Library:GetDarkerColor(Library.AccentColor);

function Library:AddToRegistry(Instance, Properties, IsHud)
    local Idx = #Library.Registry + 1;
    local Data = {
        Instance = Instance;
        Properties = Properties;
        Idx = Idx;
    };

    table.insert(Library.Registry, Data);
    Library.RegistryMap[Instance] = Data;

    if IsHud then
        table.insert(Library.HudRegistry, Data);
    end;
end;

function Library:RemoveFromRegistry(Instance)
    local Data = Library.RegistryMap[Instance];

    if Data then
        for Idx = #Library.Registry, 1, -1 do
            if Library.Registry[Idx] == Data then
                table.remove(Library.Registry, Idx);
            end;
        end;

        for Idx = #Library.HudRegistry, 1, -1 do
            if Library.HudRegistry[Idx] == Data then
                table.remove(Library.HudRegistry, Idx);
            end;
        end;

        Library.RegistryMap[Instance] = nil;
    end;
end;

function Library:UpdateColorsUsingRegistry()
    for Idx, Object in next, Library.Registry do
        for Property, ColorIdx in next, Object.Properties do
            if type(ColorIdx) == 'string' then
                Object.Instance[Property] = Library[ColorIdx];
            elseif type(ColorIdx) == 'function' then
                Object.Instance[Property] = ColorIdx()
            end
        end;
    end;
end;

function Library:GiveSignal(Signal)
    table.insert(Library.Signals, Signal)
end

function Library:MouseIsOverOpenedFrame()
    for Frame, _ in next, Library.OpenedFrames do
        local AbsPos, AbsSize = Frame.AbsolutePosition, Frame.AbsoluteSize;

        if Mouse.X >= AbsPos.X and Mouse.X <= AbsPos.X + AbsSize.X
            and Mouse.Y >= AbsPos.Y and Mouse.Y <= AbsPos.Y + AbsSize.Y then

            return true;
        end;
    end;
end;

function Library:IsMouseOverFrame(Frame)
    local AbsPos, AbsSize = Frame.AbsolutePosition, Frame.AbsoluteSize;

    if Mouse.X >= AbsPos.X and Mouse.X <= AbsPos.X + AbsSize.X
        and Mouse.Y >= AbsPos.Y and Mouse.Y <= AbsPos.Y + AbsSize.Y then

        return true;
    end;
end;

-- Create essential UI elements
do
    Library.NotificationArea = Library:Create('Frame', {
        BackgroundTransparency = 1;
        Position = UDim2.new(0, 0, 0, 40);
        Size = UDim2.new(0, 300, 0, 200);
        ZIndex = 100;
        Parent = ScreenGui;
    });

    Library:Create('UIListLayout', {
        Padding = UDim.new(0, 4);
        FillDirection = Enum.FillDirection.Vertical;
        SortOrder = Enum.SortOrder.LayoutOrder;
        Parent = Library.NotificationArea;
    });

    local WatermarkOuter = Library:Create('Frame', {
        BorderColor3 = Color3.new(0, 0, 0);
        Position = UDim2.new(0, 100, 0, -25);
        Size = UDim2.new(0, 213, 0, 20);
        ZIndex = 200;
        Visible = false;
        Parent = ScreenGui;
    });

    local WatermarkInner = Library:Create('Frame', {
        BackgroundColor3 = Library.MainColor;
        BorderColor3 = Library.AccentColor;
        BorderMode = Enum.BorderMode.Inset;
        Size = UDim2.new(1, 0, 1, 0);
        ZIndex = 201;
        Parent = WatermarkOuter;
    });

    Library:AddToRegistry(WatermarkInner, {
        BorderColor3 = 'AccentColor';
    });

    local WatermarkLabel = Library:CreateLabel({
        Position = UDim2.new(0, 5, 0, 0);
        Size = UDim2.new(1, -4, 1, 0);
        TextSize = 14;
        TextXAlignment = Enum.TextXAlignment.Left;
        ZIndex = 203;
        Parent = WatermarkInner;
    });

    Library.Watermark = WatermarkOuter;
    Library.WatermarkText = WatermarkLabel;
    Library:MakeDraggable(Library.Watermark);
end;

-- Enhanced notifications with modern design
function Library:Notify(Text, Time)
    Time = Time or 4

    local XSize, YSize = Library:GetTextBounds(Text, Library.Font, 14);
    YSize = YSize + 20

    local NotifyOuter = Library:Create('Frame', {
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.AccentColor,
        BorderSizePixel = 2,
        Position = UDim2.new(1, 10, 0, 10),
        Size = UDim2.new(0, 0, 0, YSize),
        AnchorPoint = Vector2.new(1, 0),
        ClipsDescendants = true,
        ZIndex = 100,
        Parent = Library.NotificationArea;
    });

    Library:ApplyGlow(NotifyOuter, 0.4)

    local NotifyLabel = Library:CreateLabel({
        Position = UDim2.new(0, 15, 0, 0);
        Size = UDim2.new(1, -15, 1, 0);
        Text = Text;
        TextXAlignment = Enum.TextXAlignment.Left;
        TextSize = 14;
        ZIndex = 101;
        Parent = NotifyOuter;
    });

    local ProgressBar = Library:Create('Frame', {
        BackgroundColor3 = Library.AccentColor,
        BorderSizePixel = 0,
        Size = UDim2.new(0, 0, 0, 3),
        Position = UDim2.new(0, 0, 1, -3),
        ZIndex = 102;
        Parent = NotifyOuter;
    });

    -- Smooth entrance animation
    if Library.AnimationsEnabled then
        local EnterTween = TweenService:Create(NotifyOuter, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, XSize + 30, 0, YSize)
        })
        EnterTween:Play()

        local ProgressTween = TweenService:Create(ProgressBar, TweenInfo.new(Time, Enum.EasingStyle.Linear), {
            Size = UDim2.new(1, 0, 0, 3)
        })
        ProgressTween:Play()
    else
        NotifyOuter.Size = UDim2.new(0, XSize + 30, 0, YSize)
    end

    task.spawn(function()
        wait(Time);

        if Library.AnimationsEnabled then
            local ExitTween = TweenService:Create(NotifyOuter, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
                Size = UDim2.new(0, 0, 0, YSize)
            })
            ExitTween:Play()
            wait(0.3)
        end

        NotifyOuter:Destroy();
    end);
end;

-- Enhanced watermark
function Library:SetWatermark(Text)
    local X, Y = Library:GetTextBounds(Text, Library.Font, 14);
    Library.Watermark.Size = UDim2.new(0, X + 30, 0, (Y * 1.5) + 10);
    Library:SetWatermarkVisibility(true)

    Library.WatermarkText.Text = Text;
    
    -- Add subtle animation
    if Library.AnimationsEnabled then
        Library.Watermark.Position = UDim2.new(0.5, -((X + 30)/2), 0, 10)
    end
end;

function Library:SetWatermarkVisibility(Bool)
    Library.Watermark.Visible = Bool;
end;

-- Enhanced window creation with modern UI
function Library:CreateWindow(Config)
    Config = Config or {}
    Config.Title = Config.Title or 'Nexus UI'
    Config.Size = Config.Size or UDim2.fromOffset(600, 650)
    Config.Position = Config.Position or UDim2.fromOffset(100, 50)

    local Window = {
        Tabs = {};
    };

    -- Modern window design
    local Outer = Library:Create('Frame', {
        AnchorPoint = Config.AnchorPoint or Vector2.zero,
        BackgroundColor3 = Library.MainColor,
        BorderColor3 = Library.AccentColor,
        BorderSizePixel = 2,
        Position = Config.Position,
        Size = Config.Size,
        Visible = false,
        ZIndex = 1,
        Parent = ScreenGui,
    });

    Library:ApplyGlow(Outer, 0.6)
    Library:MakeDraggable(Outer, 35);

    -- Enhanced header
    local Header = Library:Create('Frame', {
        BackgroundColor3 = Library.AccentColor,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 35),
        ZIndex = 2,
        Parent = Outer,
    });

    local WindowLabel = Library:CreateLabel({
        Position = UDim2.new(0, 15, 0, 0),
        Size = UDim2.new(0, 0, 1, 0),
        Text = Config.Title,
        TextColor3 = Library.White,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 3,
        Parent = Header,
    });

    -- Return basic window structure for now
    -- Full implementation would continue with tabs, etc.

    function Window:Show()
        Outer.Visible = true
    end

    function Window:Hide()
        Outer.Visible = false
    end

    Window.Holder = Outer
    return Window
end

-- New feature: Theme system
Library.Themes = {
    Dark = {
        MainColor = Color3.fromRGB(15, 15, 20),
        BackgroundColor = Color3.fromRGB(10, 10, 15),
        AccentColor = Color3.fromRGB(0, 180, 255),
        FontColor = Color3.fromRGB(240, 240, 240)
    },
    Light = {
        MainColor = Color3.fromRGB(240, 240, 245),
        BackgroundColor = Color3.fromRGB(220, 220, 230),
        AccentColor = Color3.fromRGB(0, 120, 215),
        FontColor = Color3.fromRGB(30, 30, 30)
    },
    Purple = {
        MainColor = Color3.fromRGB(20, 15, 30),
        BackgroundColor = Color3.fromRGB(15, 10, 25),
        AccentColor = Color3.fromRGB(160, 100, 255),
        FontColor = Color3.fromRGB(240, 240, 240)
    }
}

function Library:SetTheme(ThemeName)
    local Theme = Library.Themes[ThemeName]
    if Theme then
        for Property, Value in next, Theme do
            Library[Property] = Value
        end
        Library:UpdateColorsUsingRegistry()
    end
end

getgenv().Library = Library
return Library
