-- Custom UI Library - Hybrid of Both Libraries
local cloneref = (cloneref or clonereference or function(instance: any)
    return instance
end)

-- Services
local CoreGui: CoreGui = cloneref(game:GetService("CoreGui"))
local Players: Players = cloneref(game:GetService("Players"))
local RunService: RunService = cloneref(game:GetService("RunService"))
local UserInputService: UserInputService = cloneref(game:GetService("UserInputService"))
local TextService: TextService = cloneref(game:GetService("TextService"))
local TweenService: TweenService = cloneref(game:GetService("TweenService"))

-- Security
local protectgui = protectgui or (syn and syn.protect_gui) or function() end
local gethui = gethui or function()
    return CoreGui
end

-- Player
local LocalPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()
local Mouse = cloneref(LocalPlayer:GetMouse())

-- Custom Library
local CustomLibrary = {
    -- Core Properties
    Toggles = {},
    Options = {},
    Labels = {},
    Buttons = {},
    
    -- UI State
    Toggled = false,
    Unloaded = false,
    ActiveTab = nil,
    Tabs = {},
    
    -- Visual Settings
    Theme = {
        -- Modern Color Scheme
        Background = Color3.fromRGB(20, 20, 25),
        Main = Color3.fromRGB(30, 30, 40),
        Accent = Color3.fromRGB(0, 150, 255),
        Outline = Color3.fromRGB(50, 50, 65),
        FontColor = Color3.fromRGB(240, 240, 245),
        Risk = Color3.fromRGB(255, 75, 75),
        
        -- Font
        Font = Enum.Font.Gotham,
        
        -- Effects
        CornerRadius = 6,
        ShadowEnabled = true
    },
    
    -- Configuration
    Config = {
        ToggleKey = Enum.KeyCode.RightControl,
        Watermark = "Custom UI Library",
        NotifySide = "Right",
        ShowCustomCursor = true,
        Resizable = true,
        MinSize = Vector2.new(500, 400)
    },
    
    -- Internal
    Signals = {},
    Registry = {},
    OpenedFrames = {}
}

-- DPI Scaling
local DPIScale = 1
function CustomLibrary:SetDPIScale(scale)
    DPIScale = scale / 100
end

-- Utility Functions
local function ApplyDPIScale(dimension)
    return UDim2.new(
        dimension.X.Scale,
        dimension.X.Offset * DPIScale,
        dimension.Y.Scale,
        dimension.Y.Offset * DPIScale
    )
end

local function ApplyTextScale(size)
    return size * DPIScale
end

function CustomLibrary:SafeCallback(func, ...)
    if func and type(func) == "function" then
        local success, result = pcall(func, ...)
        if not success then
            warn("Callback error:", result)
        end
        return result
    end
end

-- Instance Creation with Modern Styling
function CustomLibrary:Create(className, properties)
    local instance = Instance.new(className)
    
    -- Apply DPI scaling to relevant properties
    if properties.Size then
        properties.Size = ApplyDPIScale(properties.Size)
    end
    if properties.Position then
        properties.Position = ApplyDPIScale(properties.Position)
    end
    if properties.TextSize then
        properties.TextSize = ApplyTextScale(properties.TextSize)
    end
    
    -- Apply properties
    for property, value in pairs(properties) do
        instance[property] = value
    end
    
    return instance
end

-- Modern Styled Elements
function CustomLibrary:CreateModernFrame(properties)
    return self:Create("Frame", {
        BackgroundColor3 = self.Theme.Main,
        BorderSizePixel = 0,
        ClipsDescendants = true,
        ...properties
    })
end

function CustomLibrary:CreateModernButton(properties)
    local button = self:Create("TextButton", {
        AutoButtonColor = false,
        BackgroundColor3 = self.Theme.Main,
        BorderSizePixel = 0,
        TextColor3 = self.Theme.FontColor,
        TextSize = 14,
        Font = self.Theme.Font,
        ...properties
    })
    
    -- Add modern hover effects
    local hoverTween
    button.MouseEnter:Connect(function()
        if hoverTween then hoverTween:Cancel() end
        hoverTween = TweenService:Create(button, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(
                math.floor(self.Theme.Main.R * 255 + 10),
                math.floor(self.Theme.Main.G * 255 + 10),
                math.floor(self.Theme.Main.B * 255 + 10)
            )
        })
        hoverTween:Play()
    end)
    
    button.MouseLeave:Connect(function()
        if hoverTween then hoverTween:Cancel() end
        hoverTween = TweenService:Create(button, TweenInfo.new(0.2), {
            BackgroundColor3 = self.Theme.Main
        })
        hoverTween:Play()
    end)
    
    return button
end

-- Rounded Corners Helper
function CustomLibrary:AddCorners(instance, radius)
    local corner = self:Create("UICorner", {
        CornerRadius = UDim.new(0, radius or self.Theme.CornerRadius),
        Parent = instance
    })
    return corner
end

-- Shadow Effect
function CustomLibrary:AddShadow(instance)
    if not self.Theme.ShadowEnabled then return end
    
    local shadow = self:Create("ImageLabel", {
        Image = "rbxassetid://1316045217",
        ImageColor3 = Color3.new(0, 0, 0),
        ImageTransparency = 0.8,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(10, 10, 118, 118),
        Size = UDim2.new(1, 20, 1, 20),
        Position = UDim2.new(0, -10, 0, -10),
        BackgroundTransparency = 1,
        ZIndex = instance.ZIndex - 1,
        Parent = instance.Parent
    })
    
    return shadow
end

-- ScreenGui Management
local ScreenGui = CustomLibrary:Create("ScreenGui", {
    Name = "CustomUILibrary",
    DisplayOrder = 999,
    ResetOnSpawn = false
})

protectgui(ScreenGui)
ScreenGui.Parent = gethui()

CustomLibrary.ScreenGui = ScreenGui

-- Notification System
function CustomLibrary:Notify(title, message, duration)
    duration = duration or 5
    
    local notification = self:CreateModernFrame({
        Size = UDim2.new(0, 300, 0, 0),
        Position = self.Config.NotifySide == "Left" and 
            UDim2.new(0, 10, 0, 10) or 
            UDim2.new(1, -310, 0, 10),
        BackgroundColor3 = self.Theme.Main,
        ZIndex = 100,
        Parent = ScreenGui
    })
    
    self:AddCorners(notification, 8)
    self:AddShadow(notification)
    
    local titleLabel = self:Create("TextLabel", {
        Text = title,
        TextColor3 = self.Theme.Accent,
        TextSize = 16,
        Font = self.Theme.Font,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -20, 0, 20),
        Position = UDim2.new(0, 10, 0, 10),
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 101,
        Parent = notification
    })
    
    local messageLabel = self:Create("TextLabel", {
        Text = message,
        TextColor3 = self.Theme.FontColor,
        TextSize = 14,
        Font = self.Theme.Font,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -20, 0, 0),
        Position = UDim2.new(0, 10, 0, 35),
        TextXAlignment = Enum.TextXAlignment.Left,
        TextWrapped = true,
        ZIndex = 101,
        Parent = notification
    })
    
    -- Calculate size
    local textBounds = TextService:GetTextSize(message, 14, self.Theme.Font, Vector2.new(280, math.huge))
    notification.Size = UDim2.new(0, 300, 0, textBounds.Y + 60)
    messageLabel.Size = UDim2.new(1, -20, 0, textBounds.Y)
    
    -- Animate in
    notification.Position = self.Config.NotifySide == "Left" and 
        UDim2.new(0, -310, 0, 10) or 
        UDim2.new(1, 10, 0, 10)
    
    TweenService:Create(notification, TweenInfo.new(0.3), {
        Position = self.Config.NotifySide == "Left" and 
            UDim2.new(0, 10, 0, 10) or 
            UDim2.new(1, -310, 0, 10)
    }):Play()
    
    -- Auto remove
    task.delay(duration, function()
        TweenService:Create(notification, TweenInfo.new(0.3), {
            Position = self.Config.NotifySide == "Left" and 
                UDim2.new(0, -310, 0, 10) or 
                UDim2.new(1, 10, 0, 10)
        }):Play()
        
        task.wait(0.3)
        notification:Destroy()
    end)
end

-- Watermark
function CustomLibrary:UpdateWatermark()
    if not self.Watermark then
        self.Watermark = self:CreateModernFrame({
            Size = UDim2.new(0, 200, 0, 30),
            Position = UDim2.new(0, 10, 0, 10),
            BackgroundColor3 = self.Theme.Main,
            ZIndex = 50,
            Parent = ScreenGui
        })
        
        self:AddCorners(self.Watermark, 6)
        self:AddShadow(self.Watermark)
        
        self.WatermarkLabel = self:Create("TextLabel", {
            Text = self.Config.Watermark,
            TextColor3 = self.Theme.FontColor,
            TextSize = 14,
            Font = self.Theme.Font,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, -10, 1, 0),
            Position = UDim2.new(0, 5, 0, 0),
            ZIndex = 51,
            Parent = self.Watermark
        })
        
        -- Make draggable
        self:MakeDraggable(self.Watermark, self.Watermark)
    end
    
    self.WatermarkLabel.Text = self.Config.Watermark
    local textSize = TextService:GetTextSize(self.Config.Watermark, 14, self.Theme.Font, Vector2.new(math.huge, math.huge))
    self.Watermark.Size = UDim2.new(0, textSize.X + 20, 0, 30)
end

-- Dragging System
function CustomLibrary:MakeDraggable(frame, handle)
    handle = handle or frame
    
    local dragging = false
    local dragInput, dragStart, startPos
    
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
end

-- Window Creation
function CustomLibrary:CreateWindow(config)
    config = config or {}
    
    -- Merge with defaults
    local windowConfig = {
        Title = config.Title or "Custom Window",
        Size = config.Size or UDim2.new(0, 600, 0, 500),
        Position = config.Position or UDim2.new(0.5, -300, 0.5, -250),
        Resizable = config.Resizable ~= false,
        ...config
    }
    
    local Window = {
        Tabs = {},
        Groupboxes = {}
    }
    
    -- Main Window Frame
    local mainFrame = self:CreateModernFrame({
        Size = windowConfig.Size,
        Position = windowConfig.Position,
        BackgroundColor3 = self.Theme.Background,
        ZIndex = 10,
        Parent = ScreenGui
    })
    
    self:AddCorners(mainFrame, 8)
    self:AddShadow(mainFrame)
    
    -- Title Bar
    local titleBar = self:CreateModernFrame({
        Size = UDim2.new(1, 0, 0, 40),
        BackgroundColor3 = self.Theme.Main,
        ZIndex = 11,
        Parent = mainFrame
    })
    
    self:AddCorners(titleBar, 8)
    
    local titleLabel = self:Create("TextLabel", {
        Text = windowConfig.Title,
        TextColor3 = self.Theme.FontColor,
        TextSize = 18,
        Font = self.Theme.Font,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -40, 1, 0),
        Position = UDim2.new(0, 10, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 12,
        Parent = titleBar
    })
    
    -- Close Button
    local closeButton = self:CreateModernButton({
        Size = UDim2.new(0, 30, 0, 30),
        Position = UDim2.new(1, -35, 0, 5),
        Text = "Ã—",
        TextSize = 20,
        ZIndex = 12,
        Parent = titleBar
    })
    
    closeButton.MouseButton1Click:Connect(function()
        self:Toggle()
    end)
    
    -- Make draggable
    self:MakeDraggable(mainFrame, titleBar)
    
    -- Tab Container
    local tabContainer = self:CreateModernFrame({
        Size = UDim2.new(1, -20, 0, 40),
        Position = UDim2.new(0, 10, 0, 50),
        BackgroundColor3 = self.Theme.Main,
        ZIndex = 11,
        Parent = mainFrame
    })
    
    self:AddCorners(tabContainer, 6)
    
    local tabListLayout = self:Create("UIListLayout", {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 5),
        Parent = tabContainer
    })
    
    -- Content Area
    local contentArea = self:CreateModernFrame({
        Size = UDim2.new(1, -20, 1, -100),
        Position = UDim2.new(0, 10, 0, 100),
        BackgroundColor3 = self.Theme.Background,
        ZIndex = 11,
        Parent = mainFrame
    })
    
    self:AddCorners(contentArea, 6)
    
    -- Resize Handle
    if windowConfig.Resizable then
        local resizeHandle = self:Create("Frame", {
            Size = UDim2.new(0, 20, 0, 20),
            Position = UDim2.new(1, -20, 1, -20),
            BackgroundTransparency = 1,
            ZIndex = 12,
            Parent = mainFrame
        })
        
        self:MakeResizable(mainFrame, resizeHandle)
    end
    
    -- Window Methods
    function Window:AddTab(name, icon)
        local tab = {
            Name = name,
            Elements = {}
        }
        
        local tabButton = self:CreateModernButton({
            Size = UDim2.new(0, 100, 0, 30),
            Text = name,
            ZIndex = 12,
            Parent = tabContainer
        })
        
        self:AddCorners(tabButton, 4)
        
        local tabContent = self:CreateModernFrame({
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Visible = false,
            ZIndex = 11,
            Parent = contentArea
        })
        
        -- Tab selection
        tabButton.MouseButton1Click:Connect(function()
            for _, otherTab in pairs(Window.Tabs) do
                otherTab.Content.Visible = false
                otherTab.Button.BackgroundColor3 = self.Theme.Main
            end
            
            tabContent.Visible = true
            tabButton.BackgroundColor3 = self.Theme.Accent
        end)
        
        tab.Button = tabButton
        tab.Content = tabContent
        Window.Tabs[name] = tab
        
        -- Select first tab
        if not Window.ActiveTab then
            Window.ActiveTab = tab
            tabContent.Visible = true
            tabButton.BackgroundColor3 = self.Theme.Accent
        end
        
        return tab
    end
    
    -- Store reference
    Window.MainFrame = mainFrame
    self.Window = Window
    
    -- Initialize watermark
    self:UpdateWatermark()
    
    return Window
end

-- Resize Functionality
function CustomLibrary:MakeResizable(frame, handle)
    local dragging = false
    local dragInput, dragStart, startSize
    
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startSize = frame.Size
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            local newSize = UDim2.new(
                startSize.X.Scale,
                math.max(self.Config.MinSize.X, startSize.X.Offset + delta.X),
                startSize.Y.Scale,
                math.max(self.Config.MinSize.Y, startSize.Y.Offset + delta.Y)
            )
            frame.Size = newSize
        end
    end)
end

-- Toggle UI Visibility
function CustomLibrary:Toggle()
    self.Toggled = not self.Toggled
    
    if self.Window and self.Window.MainFrame then
        self.Window.MainFrame.Visible = self.Toggled
    end
    
    if self.Watermark then
        self.Watermark.Visible = self.Toggled
    end
end

-- Input Handling
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == self.Config.ToggleKey then
        self:Toggle()
    end
end)

-- Base Groupbox System (simplified)
local BaseGroupbox = {}

function BaseGroupbox:AddLabel(text)
    local label = self.Library:Create("TextLabel", {
        Text = text,
        TextColor3 = self.Library.Theme.FontColor,
        TextSize = 14,
        Font = self.Library.Theme.Font,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -10, 0, 20),
        Position = UDim2.new(0, 5, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = self.Container
    })
    
    return label
end

function BaseGroupbox:AddButton(text, callback)
    local button = self.Library:CreateModernButton({
        Size = UDim2.new(1, -10, 0, 30),
        Position = UDim2.new(0, 5, 0, 0),
        Text = text,
        Parent = self.Container
    })
    
    self.Library:AddCorners(button, 4)
    
    button.MouseButton1Click:Connect(function()
        self.Library:SafeCallback(callback)
    end)
    
    return button
end

function BaseGroupbox:AddToggle(text, defaultValue, callback)
    local toggle = {
        Value = defaultValue or false,
        Type = "Toggle"
    }
    
    local toggleFrame = self.Library:CreateModernFrame({
        Size = UDim2.new(1, -10, 0, 30),
        Position = UDim2.new(0, 5, 0, 0),
        BackgroundColor3 = self.Library.Theme.Main,
        Parent = self.Container
    })
    
    self.Library:AddCorners(toggleFrame, 4)
    
    local label = self.Library:Create("TextLabel", {
        Text = text,
        TextColor3 = self.Library.Theme.FontColor,
        TextSize = 14,
        Font = self.Library.Theme.Font,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -40, 1, 0),
        Position = UDim2.new(0, 10, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = toggleFrame
    })
    
    local toggleButton = self.Library:CreateModernFrame({
        Size = UDim2.new(0, 20, 0, 20),
        Position = UDim2.new(1, -30, 0, 5),
        BackgroundColor3 = defaultValue and self.Library.Theme.Accent or self.Library.Theme.Main,
        Parent = toggleFrame
    })
    
    self.Library:AddCorners(toggleButton, 10)
    
    function toggle:SetValue(value)
        toggle.Value = value
        toggleButton.BackgroundColor3 = value and self.Library.Theme.Accent or self.Library.Theme.Main
        self.Library:SafeCallback(callback, value)
    end
    
    toggleFrame.MouseButton1Click:Connect(function()
        toggle:SetValue(not toggle.Value)
    end)
    
    self.Library.Toggles[text] = toggle
    return toggle
end

-- Final Setup
CustomLibrary.BaseGroupbox = BaseGroupbox

-- Make accessible globally
getgenv().CustomLibrary = CustomLibrary

return CustomLibrary
