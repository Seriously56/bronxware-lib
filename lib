-- Custom UI Library - Comprehensive Version (1500+ lines)
local cloneref = (cloneref or clonereference or function(instance: any)
    return instance
end)

-- Services
local CoreGui = cloneref(game:GetService("CoreGui"))
local Players = cloneref(game:GetService("Players"))
local RunService = cloneref(game:GetService("RunService"))
local UserInputService = cloneref(game:GetService("UserInputService"))
local TextService = cloneref(game:GetService("TextService"))
local TweenService = cloneref(game:GetService("TweenService"))
local HttpService = cloneref(game:GetService("HttpService"))

-- Security
local protectgui = protectgui or (syn and syn.protect_gui) or function() end
local gethui = gethui or function() return CoreGui end

-- Player
local LocalPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()
local Mouse = LocalPlayer:GetMouse()

-- Main Library Table
local CustomLibrary = {
    -- Data Storage
    Toggles = {},
    Options = {},
    Labels = {},
    Buttons = {},
    Keybinds = {},
    
    -- UI State
    Toggled = false,
    Unloaded = false,
    ActiveTab = nil,
    Tabs = {},
    OpenedFrames = {},
    
    -- Visual Settings
    Theme = {
        -- Modern Color Scheme
        Background = Color3.fromRGB(15, 15, 20),
        Main = Color3.fromRGB(25, 25, 35),
        Accent = Color3.fromRGB(0, 140, 255),
        Outline = Color3.fromRGB(45, 45, 60),
        FontColor = Color3.fromRGB(240, 240, 250),
        Risk = Color3.fromRGB(255, 70, 70),
        Success = Color3.fromRGB(70, 255, 70),
        
        -- Font
        Font = Enum.Font.Gotham,
        
        -- Effects
        CornerRadius = 8,
        ShadowEnabled = true,
        AnimationSpeed = 0.15
    },
    
    -- Configuration
    Config = {
        ToggleKey = Enum.KeyCode.RightControl,
        Watermark = "Custom UI Library v2.0",
        NotifySide = "Right",
        ShowCustomCursor = true,
        Resizable = true,
        MinSize = Vector2.new(550, 400),
        MaxSize = Vector2.new(1200, 800)
    },
    
    -- Internal
    Signals = {},
    Registry = {},
    Notifications = {},
    ScreenGui = nil
}

-- DPI Scaling System
local DPIScale = 1
function CustomLibrary:SetDPIScale(scale)
    DPIScale = math.clamp(scale / 100, 0.5, 2)
    self.Config.MinSize = Vector2.new(550, 400) * DPIScale
end

-- Utility Functions
local function ApplyDPIScale(dimension)
    return UDim2.new(
        dimension.X.Scale,
        dimension.X.Offset * DPIScale,
        dimension.Y.Scale,
        dimension.Y.Offset * DPIScale
    )
end

local function ApplyTextScale(size)
    return math.floor(size * DPIScale)
end

function CustomLibrary:SafeCallback(func, ...)
    if type(func) == "function" then
        local success, result = pcall(func, ...)
        if not success then
            self:Notify("Callback Error", result, 5)
        end
        return result
    end
end

function CustomLibrary:GetTextBounds(text, font, size, width)
    local bounds = TextService:GetTextSize(text, size, font, width or Vector2.new(10000, 10000))
    return bounds.X, bounds.Y
end

-- Instance Creation System
function CustomLibrary:Create(className, properties)
    local instance = Instance.new(className)
    
    -- Apply DPI scaling
    local scaledProps = {}
    for prop, value in pairs(properties) do
        if prop == "Size" or prop == "Position" then
            scaledProps[prop] = ApplyDPIScale(value)
        elseif prop == "TextSize" then
            scaledProps[prop] = ApplyTextScale(value)
        else
            scaledProps[prop] = value
        end
    end
    
    -- Apply properties
    for prop, value in pairs(scaledProps) do
        pcall(function()
            instance[prop] = value
        end)
    end
    
    return instance
end

-- Visual Element Creators
function CustomLibrary:CreateModernFrame(properties)
    return self:Create("Frame", {
        BackgroundColor3 = self.Theme.Main,
        BorderSizePixel = 0,
        ClipsDescendants = true,
        ...properties
    })
end

function CustomLibrary:CreateModernButton(properties)
    local button = self:Create("TextButton", {
        AutoButtonColor = false,
        BackgroundColor3 = self.Theme.Main,
        BorderSizePixel = 0,
        TextColor3 = self.Theme.FontColor,
        TextSize = 14,
        Font = self.Theme.Font,
        TextTransparency = 0,
        ...properties
    })
    
    return button
end

function CustomLibrary:CreateLabel(properties)
    return self:Create("TextLabel", {
        BackgroundTransparency = 1,
        TextColor3 = self.Theme.FontColor,
        TextSize = 14,
        Font = self.Theme.Font,
        TextTransparency = 0,
        ...properties
    })
end

-- Rounded Corners
function CustomLibrary:AddCorners(instance, radius)
    return self:Create("UICorner", {
        CornerRadius = UDim.new(0, radius or self.Theme.CornerRadius),
        Parent = instance
    })
end

-- Shadow Effect
function CustomLibrary:AddShadow(instance)
    if not self.Theme.ShadowEnabled then return end
    
    local shadow = self:Create("ImageLabel", {
        Image = "rbxassetid://1316045217",
        ImageColor3 = Color3.new(0, 0, 0),
        ImageTransparency = 0.8,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(10, 10, 118, 118),
        Size = UDim2.new(1, 20, 1, 20),
        Position = UDim2.new(0, -10, 0, -10),
        BackgroundTransparency = 1,
        ZIndex = instance.ZIndex - 1,
        Parent = instance.Parent
    })
    
    return shadow
end

-- Hover Effects System
function CustomLibrary:AddHoverEffect(instance, properties)
    local originalProps = {}
    for prop, value in pairs(properties) do
        originalProps[prop] = instance[prop]
    end
    
    local hoverTween
    instance.MouseEnter:Connect(function()
        if hoverTween then hoverTween:Cancel() end
        
        local targetProps = {}
        for prop, value in pairs(properties) do
            targetProps[prop] = value
        end
        
        hoverTween = TweenService:Create(instance, TweenInfo.new(self.Theme.AnimationSpeed), targetProps)
        hoverTween:Play()
    end)
    
    instance.MouseLeave:Connect(function()
        if hoverTween then hoverTween:Cancel() end
        
        hoverTween = TweenService:Create(instance, TweenInfo.new(self.Theme.AnimationSpeed), originalProps)
        hoverTween:Play()
    end)
end

-- ScreenGui Management
do
    local screenGui = CustomLibrary:Create("ScreenGui", {
        Name = "CustomUILibrary",
        DisplayOrder = 999,
        ResetOnSpawn = false
    })
    
    protectgui(screenGui)
    screenGui.Parent = gethui()
    CustomLibrary.ScreenGui = screenGui
end

-- Notification System
function CustomLibrary:Notify(title, message, duration, options)
    duration = duration or 5
    options = options or {}
    
    local notificationId = HttpService:GenerateGUID(false)
    local side = options.Side or self.Config.NotifySide
    
    -- Notification container
    local notification = self:CreateModernFrame({
        Size = UDim2.new(0, 320, 0, 0),
        Position = side == "Left" and 
            UDim2.new(0, -330, 0, 10) or 
            UDim2.new(1, 10, 0, 10),
        BackgroundColor3 = self.Theme.Main,
        ZIndex = 100,
        Parent = self.ScreenGui
    })
    
    self:AddCorners(notification, 8)
    self:AddShadow(notification)
    
    -- Title bar
    local titleBar = self:CreateModernFrame({
        Size = UDim2.new(1, 0, 0, 30),
        BackgroundColor3 = self.Theme.Accent,
        ZIndex = 101,
        Parent = notification
    })
    
    self:AddCorners(titleBar, 8)
    
    local titleLabel = self:CreateLabel({
        Text = title,
        TextColor3 = Color3.new(1, 1, 1),
        TextSize = 16,
        Font = Enum.Font.GothamBold,
        Size = UDim2.new(1, -40, 1, 0),
        Position = UDim2.new(0, 10, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 102,
        Parent = titleBar
    })
    
    -- Close button
    local closeButton = self:CreateModernButton({
        Size = UDim2.new(0, 20, 0, 20),
        Position = UDim2.new(1, -25, 0, 5),
        Text = "×",
        TextColor3 = Color3.new(1, 1, 1),
        TextSize = 18,
        BackgroundColor3 = Color3.new(1, 1, 1),
        BackgroundTransparency = 0.8,
        ZIndex = 102,
        Parent = titleBar
    })
    
    self:AddCorners(closeButton, 10)
    
    -- Message content
    local messageLabel = self:CreateLabel({
        Text = message,
        TextSize = 14,
        Size = UDim2.new(1, -20, 0, 0),
        Position = UDim2.new(0, 10, 0, 40),
        TextWrapped = true,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 101,
        Parent = notification
    })
    
    -- Calculate size
    local textBounds = TextService:GetTextSize(message, 14, self.Theme.Font, Vector2.new(300, math.huge))
    local totalHeight = math.max(80, textBounds.Y + 60)
    messageLabel.Size = UDim2.new(1, -20, 0, textBounds.Y)
    notification.Size = UDim2.new(0, 320, 0, totalHeight)
    
    -- Progress bar for duration
    local progressBar = self:CreateModernFrame({
        Size = UDim2.new(1, 0, 0, 3),
        Position = UDim2.new(0, 0, 1, -3),
        BackgroundColor3 = self.Theme.Accent,
        ZIndex = 101,
        Parent = notification
    })
    
    -- Animation
    local targetPos = side == "Left" and 
        UDim2.new(0, 10, 0, 10) or 
        UDim2.new(1, -330, 0, 10)
    
    TweenService:Create(notification, TweenInfo.new(0.3), {
        Position = targetPos
    }):Play()
    
    -- Progress animation
    TweenService:Create(progressBar, TweenInfo.new(duration), {
        Size = UDim2.new(0, 0, 0, 3)
    }):Play()
    
    -- Close functionality
    local function closeNotification()
        TweenService:Create(notification, TweenInfo.new(0.3), {
            Position = side == "Left" and 
                UDim2.new(0, -330, 0, 10) or 
                UDim2.new(1, 10, 0, 10)
        }):Play()
        
        task.wait(0.3)
        notification:Destroy()
        self.Notifications[notificationId] = nil
    end
    
    closeButton.MouseButton1Click:Connect(closeNotification)
    
    -- Auto-close
    if duration > 0 then
        task.delay(duration, closeNotification)
    end
    
    self.Notifications[notificationId] = notification
    return notificationId
end

-- Watermark System
function CustomLibrary:UpdateWatermark(text)
    if not self.Watermark then
        self.Watermark = self:CreateModernFrame({
            Size = UDim2.new(0, 200, 0, 35),
            Position = UDim2.new(0, 10, 0, 10),
            BackgroundColor3 = self.Theme.Main,
            ZIndex = 50,
            Parent = self.ScreenGui
        })
        
        self:AddCorners(self.Watermark, 8)
        self:AddShadow(self.Watermark)
        
        self.WatermarkLabel = self:CreateLabel({
            Text = text or self.Config.Watermark,
            TextSize = 14,
            Size = UDim2.new(1, -10, 1, 0),
            Position = UDim2.new(0, 5, 0, 0),
            TextXAlignment = Enum.TextXAlignment.Left,
            ZIndex = 51,
            Parent = self.Watermark
        })
        
        -- Make draggable
        self:MakeDraggable(self.Watermark, self.Watermark)
        
        -- Add hover effect
        self:AddHoverEffect(self.Watermark, {
            BackgroundColor3 = Color3.fromRGB(35, 35, 45)
        })
    else
        self.WatermarkLabel.Text = text or self.Config.Watermark
        local textSize = TextService:GetTextSize(self.WatermarkLabel.Text, 14, self.Theme.Font, Vector2.new(math.huge, math.huge))
        self.Watermark.Size = UDim2.new(0, textSize.X + 20, 0, 35)
    end
end

-- Dragging System
function CustomLibrary:MakeDraggable(frame, handle)
    handle = handle or frame
    
    local dragging = false
    local dragInput, dragStart, startPos
    
    local function update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
    
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

-- Resize System
function CustomLibrary:MakeResizable(frame, handle)
    local dragging = false
    local dragInput, dragStart, startSize
    
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startSize = frame.Size
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            local newSize = UDim2.new(
                startSize.X.Scale,
                math.max(self.Config.MinSize.X, math.min(self.Config.MaxSize.X, startSize.X.Offset + delta.X)),
                startSize.Y.Scale,
                math.max(self.Config.MinSize.Y, math.min(self.Config.MaxSize.Y, startSize.Y.Offset + delta.Y))
            )
            frame.Size = newSize
        end
    end)
end

-- Window Creation System
function CustomLibrary:CreateWindow(config)
    config = config or {}
    
    -- Merge configuration
    local windowConfig = {
        Title = config.Title or "Custom Window",
        Size = config.Size or UDim2.new(0, 600, 0, 500),
        Position = config.Position or UDim2.new(0.5, -300, 0.5, -250),
        Resizable = config.Resizable ~= false,
        ShowWatermark = config.ShowWatermark ~= false,
        ...config
    }
    
    local Window = {
        Tabs = {},
        ActiveTab = nil,
        Groupboxes = {}
    }
    
    -- Main Window Frame
    local mainFrame = self:CreateModernFrame({
        Size = windowConfig.Size,
        Position = windowConfig.Position,
        BackgroundColor3 = self.Theme.Background,
        ZIndex = 10,
        Parent = self.ScreenGui
    })
    
    self:AddCorners(mainFrame, 12)
    self:AddShadow(mainFrame)
    
    -- Title Bar
    local titleBar = self:CreateModernFrame({
        Size = UDim2.new(1, 0, 0, 45),
        BackgroundColor3 = self.Theme.Main,
        ZIndex = 11,
        Parent = mainFrame
    })
    
    self:AddCorners(titleBar, 12)
    
    local titleLabel = self:CreateLabel({
        Text = windowConfig.Title,
        TextColor3 = self.Theme.FontColor,
        TextSize = 18,
        Font = Enum.Font.GothamBold,
        Size = UDim2.new(1, -100, 1, 0),
        Position = UDim2.new(0, 15, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 12,
        Parent = titleBar
    })
    
    -- Control Buttons
    local controlFrame = self:CreateModernFrame({
        Size = UDim2.new(0, 80, 1, 0),
        Position = UDim2.new(1, -85, 0, 0),
        BackgroundTransparency = 1,
        ZIndex = 12,
        Parent = titleBar
    })
    
    -- Minimize Button
    local minButton = self:CreateModernButton({
        Size = UDim2.new(0, 30, 0, 30),
        Position = UDim2.new(0, 5, 0, 7),
        Text = "_",
        TextSize = 16,
        BackgroundColor3 = Color3.fromRGB(255, 200, 0),
        ZIndex = 13,
        Parent = controlFrame
    })
    
    self:AddCorners(minButton, 6)
    
    -- Close Button
    local closeButton = self:CreateModernButton({
        Size = UDim2.new(0, 30, 0, 30),
        Position = UDim2.new(1, -35, 0, 7),
        Text = "×",
        TextSize = 18,
        BackgroundColor3 = Color3.fromRGB(255, 70, 70),
        ZIndex = 13,
        Parent = controlFrame
    })
    
    self:AddCorners(closeButton, 6)
    
    -- Tab Container
    local tabContainer = self:CreateModernFrame({
        Size = UDim2.new(1, -30, 0, 45),
        Position = UDim2.new(0, 15, 0, 55),
        BackgroundColor3 = self.Theme.Main,
        ZIndex = 11,
        Parent = mainFrame
    })
    
    self:AddCorners(tabContainer, 8)
    
    local tabListLayout = self:Create("UIListLayout", {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 8),
        Parent = tabContainer
    })
    
    local tabPadding = self:Create("UIPadding", {
        PaddingLeft = UDim.new(0, 10),
        PaddingRight = UDim.new(0, 10),
        Parent = tabContainer
    })
    
    -- Content Area
    local contentArea = self:CreateModernFrame({
        Size = UDim2.new(1, -30, 1, -120),
        Position = UDim2.new(0, 15, 0, 110),
        BackgroundColor3 = self.Theme.Background,
        ZIndex = 11,
        Parent = mainFrame
    })
    
    self:AddCorners(contentArea, 8)
    
    -- Resize Handle
    if windowConfig.Resizable then
        local resizeHandle = self:Create("ImageButton", {
            Size = UDim2.new(0, 20, 0, 20),
            Position = UDim2.new(1, -20, 1, -20),
            BackgroundTransparency = 1,
            Image = "rbxassetid://11144247093",
            ImageColor3 = self.Theme.Accent,
            ZIndex = 12,
            Parent = mainFrame
        })
        
        self:MakeResizable(mainFrame, resizeHandle)
    end
    
    -- Window Methods
    function Window:AddTab(name, icon)
        local tab = {
            Name = name,
            Content = nil,
            Button = nil,
            Elements = {}
        }
        
        -- Tab Button
        local tabButton = self:CreateModernButton({
            Size = UDim2.new(0, 120, 0, 35),
            Text = name,
            TextSize = 14,
            Font = Enum.Font.GothamSemibold,
            ZIndex = 12,
            Parent = tabContainer
        })
        
        self:AddCorners(tabButton, 6)
        
        -- Tab Content
        local tabContent = self:CreateModernFrame({
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Visible = false,
            ZIndex = 11,
            Parent = contentArea
        })
        
        -- Left Side Container
        local leftSide = self:CreateModernFrame({
            Size = UDim2.new(0.5, -10, 1, 0),
            BackgroundTransparency = 1,
            ZIndex = 11,
            Parent = tabContent
        })
        
        -- Right Side Container
        local rightSide = self:CreateModernFrame({
            Size = UDim2.new(0.5, -10, 1, 0),
            Position = UDim2.new(0.5, 10, 0, 0),
            BackgroundTransparency = 1,
            ZIndex = 11,
            Parent = tabContent
        })
        
        -- Layouts
        self:Create("UIListLayout", {
            Padding = UDim.new(0, 10),
            SortOrder = Enum.SortOrder.LayoutOrder,
            Parent = leftSide
        })
        
        self:Create("UIListLayout", {
            Padding = UDim.new(0, 10),
            SortOrder = Enum.SortOrder.LayoutOrder,
            Parent = rightSide
        })
        
        -- Tab Selection
        local function selectTab()
            if Window.ActiveTab then
                Window.ActiveTab.Content.Visible = false
                TweenService:Create(Window.ActiveTab.Button, TweenInfo.new(0.2), {
                    BackgroundColor3 = self.Theme.Main
                }):Play()
            end
            
            Window.ActiveTab = tab
            tabContent.Visible = true
            TweenService:Create(tabButton, TweenInfo.new(0.2), {
                BackgroundColor3 = self.Theme.Accent
            }):Play()
        end
        
        tabButton.MouseButton1Click:Connect(selectTab)
        
        -- Add hover effect
        self:AddHoverEffect(tabButton, {
            BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        })
        
        tab.Button = tabButton
        tab.Content = tabContent
        tab.LeftSide = leftSide
        tab.RightSide = rightSide
        Window.Tabs[name] = tab
        
        -- Select first tab
        if not Window.ActiveTab then
            selectTab()
        end
        
        return tab
    end
    
    function Window:AddGroupbox(tab, name, side)
        side = side or "Left"
        local container = tab.LeftSide
        if side == "Right" then
            container = tab.RightSide
        end
        
        local groupbox = {
            Name = name,
            Container = nil,
            Elements = {}
        }
        
        -- Groupbox Frame
        local groupboxFrame = self:CreateModernFrame({
            Size = UDim2.new(1, 0, 0, 0),
            BackgroundColor3 = self.Theme.Main,
            ZIndex = 12,
            Parent = container
        })
        
        self:AddCorners(groupboxFrame, 8)
        self:AddShadow(groupboxFrame)
        
        -- Header
        local header = self:CreateModernFrame({
            Size = UDim2.new(1, 0, 0, 35),
            BackgroundColor3 = self.Theme.Accent,
            ZIndex = 13,
            Parent = groupboxFrame
        })
        
        self:AddCorners(header, 8)
        
        local headerLabel = self:CreateLabel({
            Text = name,
            TextColor3 = Color3.new(1, 1, 1),
            TextSize = 16,
            Font = Enum.Font.GothamBold,
            Size = UDim2.new(1, -20, 1, 0),
            Position = UDim2.new(0, 10, 0, 0),
            TextXAlignment = Enum.TextXAlignment.Left,
            ZIndex = 14,
            Parent = header
        })
        
        -- Content Area
        local contentContainer = self:CreateModernFrame({
            Size = UDim2.new(1, 0, 1, -35),
            Position = UDim2.new(0, 0, 0, 35),
            BackgroundTransparency = 1,
            ZIndex = 13,
            Parent = groupboxFrame
        })
        
        local contentLayout = self:Create("UIListLayout", {
            Padding = UDim.new(0, 8),
            SortOrder = Enum.SortOrder.LayoutOrder,
            Parent = contentContainer
        })
        
        local contentPadding = self:Create("UIPadding", {
            PaddingLeft = UDim.new(0, 10),
            PaddingRight = UDim.new(0, 10),
            PaddingTop = UDim.new(0, 10),
            PaddingBottom = UDim.new(0, 10),
            Parent = contentContainer
        })
        
        -- Auto-resize
        contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            groupboxFrame.Size = UDim2.new(1, 0, 0, contentLayout.AbsoluteContentSize.Y + 55)
        end)
        
        groupbox.Container = contentContainer
        groupbox.Frame = groupboxFrame
        
        -- Add to groupbox metatable
        setmetatable(groupbox, { __index = self.BaseGroupbox })
        
        Window.Groupboxes[name] = groupbox
        return groupbox
    end
    
    -- Control Button Functionality
    minButton.MouseButton1Click:Connect(function()
        self:Toggle()
    end)
    
    closeButton.MouseButton1Click:Connect(function()
        self:Unload()
    end)
    
    -- Make draggable
    self:MakeDraggable(mainFrame, titleBar)
    
    -- Store references
    Window.MainFrame = mainFrame
    self.Window = Window
    
    -- Initialize watermark if enabled
    if windowConfig.ShowWatermark then
        self:UpdateWatermark()
    end
    
    return Window
end

-- Base Groupbox System
local BaseGroupbox = {
    Library = CustomLibrary
}

function BaseGroupbox:AddLabel(text, options)
    options = options or {}
    
    local label = self.Library:CreateLabel({
        Text = text,
        TextSize = options.TextSize or 14,
        Size = UDim2.new(1, 0, 0, options.Height or 20),
        TextWrapped = options.Wrapped or false,
        TextXAlignment = options.Alignment or Enum.TextXAlignment.Left,
        Parent = self.Container
    })
    
    if options.Wrapped then
        local textBounds = self.Library:GetTextBounds(text, self.Library.Theme.Font, options.TextSize or 14, Vector2.new(self.Container.AbsoluteSize.X - 20, math.huge))
        label.Size = UDim2.new(1, 0, 0, textBounds.Y + 5)
    end
    
    table.insert(self.Elements, label)
    self.Library.Labels[text] = label
    return label
end

function BaseGroupbox:AddButton(text, callback, options)
    options = options or {}
    
    local button = self.Library:CreateModernButton({
        Size = UDim2.new(1, 0, 0, 35),
        Text = text,
        Parent = self.Container
    })
    
    self.Library:AddCorners(button, 6)
    
    -- Add hover effect
    self.Library:AddHoverEffect(button, {
        BackgroundColor3 = self.Library.Theme.Accent
    })
    
    button.MouseButton1Click:Connect(function()
        self.Library:SafeCallback(callback)
    end)
    
    table.insert(self.Elements, button)
    self.Library.Buttons[text] = button
    return button
end

function BaseGroupbox:AddToggle(text, defaultValue, callback, options)
    options = options or {}
    
    local toggle = {
        Value = defaultValue or false,
        Type = "Toggle",
        Callback = callback
    }
    
    local toggleFrame = self.Library:CreateModernFrame({
        Size = UDim2.new(1, 0, 0, 30),
        BackgroundColor3 = self.Library.Theme.Main,
        Parent = self.Container
    })
    
    self.Library:AddCorners(toggleFrame, 6)
    
    local label = self.Library:CreateLabel({
        Text = text,
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 10, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = toggleFrame
    })
    
    local toggleSwitch = self.Library:CreateModernFrame({
        Size = UDim2.new(0, 40, 0, 20),
        Position = UDim2.new(1, -45, 0, 5),
        BackgroundColor3 = defaultValue and self.Library.Theme.Accent or self.Library.Theme.Outline,
        Parent = toggleFrame
    })
    
    self.Library:AddCorners(toggleSwitch, 10)
    
    local toggleKnob = self.Library:CreateModernFrame({
        Size = UDim2.new(0, 16, 0, 16),
        Position = UDim2.new(0, defaultValue and 22 or 2, 0, 2),
        BackgroundColor3 = Color3.new(1, 1, 1),
        Parent = toggleSwitch
    })
    
    self.Library:AddCorners(toggleKnob, 8)
    
    function toggle:SetValue(value)
        toggle.Value = value
        TweenService:Create(toggleSwitch, TweenInfo.new(0.2), {
            BackgroundColor3 = value and self.Library.Theme.Accent or self.Library.Theme.Outline
        }):Play()
        
        TweenService:Create(toggleKnob, TweenInfo.new(0.2), {
            Position = UDim2.new(0, value and 22 or 2, 0, 2)
        }):Play()
        
        self.Library:SafeCallback(callback, value)
    end
    
    toggleFrame.MouseButton1Click:Connect(function()
        toggle:SetValue(not toggle.Value)
    end)
    
    -- Add hover effect
    self.Library:AddHoverEffect(toggleFrame, {
        BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    })
    
    table.insert(self.Elements, toggle)
    self.Library.Toggles[text] = toggle
    return toggle
end

function BaseGroupbox:AddSlider(text, min, max, defaultValue, callback, options)
    options = options or {}
    
    local slider = {
        Value = defaultValue or min,
        Min = min,
        Max = max,
        Type = "Slider",
        Callback = callback
    }
    
    local sliderFrame = self.Library:CreateModernFrame({
        Size = UDim2.new(1, 0, 0, 60),
        BackgroundColor3 = self.Library.Theme.Main,
        Parent = self.Container
    })
    
    self.Library:AddCorners(sliderFrame, 6)
    
    local label = self.Library:CreateLabel({
        Text = text,
        Size = UDim2.new(1, -20, 0, 20),
        Position = UDim2.new(0, 10, 0, 5),
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = sliderFrame
    })
    
    local valueLabel = self.Library:CreateLabel({
        Text = tostring(defaultValue),
        Size = UDim2.new(0, 60, 0, 20),
        Position = UDim2.new(1, -65, 0, 5),
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = sliderFrame
    })
    
    local track = self.Library:CreateModernFrame({
        Size = UDim2.new(1, -20, 0, 6),
        Position = UDim2.new(0, 10, 0, 35),
        BackgroundColor3 = self.Library.Theme.Outline,
        Parent = sliderFrame
    })
    
    self.Library:AddCorners(track, 3)
    
    local fill = self.Library:CreateModernFrame({
        Size = UDim2.new((defaultValue - min) / (max - min), 0, 1, 0),
        BackgroundColor3 = self.Library.Theme.Accent,
        Parent = track
    })
    
    self.Library:AddCorners(fill, 3)
    
    local knob = self.Library:CreateModernFrame({
        Size = UDim2.new(0, 16, 0, 16),
        Position = UDim2.new((defaultValue - min) / (max - min), -8, 0.5, -8),
        BackgroundColor3 = Color3.new(1, 1, 1),
        ZIndex = 2,
        Parent = track
    })
    
    self.Library:AddCorners(knob, 8)
    self.Library:AddShadow(knob)
    
    local function setValue(value)
        value = math.clamp(value, min, max)
        slider.Value = value
        
        local percentage = (value - min) / (max - min)
        fill.Size = UDim2.new(percentage, 0, 1, 0)
        knob.Position = UDim2.new(percentage, -8, 0.5, -8)
        valueLabel.Text = tostring(math.floor(value))
        
        self.Library:SafeCallback(callback, value)
    end
    
    local function updateFromMouse()
        local mousePos = UserInputService:GetMouseLocation()
        local trackPos = track.AbsolutePosition
        local trackSize = track.AbsoluteSize
        
        local relativeX = math.clamp((mousePos.X - trackPos.X) / trackSize.X, 0, 1)
        local value = min + (max - min) * relativeX
        
        setValue(value)
    end
    
    track.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            updateFromMouse()
            
            local connection
            connection = UserInputService.InputChanged:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseMovement then
                    updateFromMouse()
                end
            end)
            
            local function disconnect()
                if connection then
                    connection:Disconnect()
                    connection = nil
                end
            end
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    disconnect()
                end
            end)
        end
    end)
    
    table.insert(self.Elements, slider)
    self.Library.Options[text] = slider
    return slider
end

-- Add more elements here (Dropdown, Keybind, ColorPicker, etc.)

-- Final setup
CustomLibrary.BaseGroupbox = BaseGroupbox

-- Toggle System
function CustomLibrary:Toggle()
    self.Toggled = not self.Toggled
    
    if self.Window and self.Window.MainFrame then
        self.Window.MainFrame.Visible = self.Toggled
    end
    
    if self.Watermark then
        self.Watermark.Visible = self.Toggled
    end
end

-- Unload System
function CustomLibrary:Unload()
    if self.Unloaded then return end
    
    -- Disconnect signals
    for _, signal in pairs(self.Signals) do
        if type(signal) == "userdata" and signal.Disconnect then
            signal:Disconnect()
        end
    end
    
    -- Clear screen GUI
    if self.ScreenGui then
        self.ScreenGui:Destroy()
    end
    
    self.Unloaded = true
    self.Toggled = false
    
    self:Notify("Unloaded", "UI Library has been unloaded", 3)
end

-- Input Handling
table.insert(CustomLibrary.Signals, UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == CustomLibrary.Config.ToggleKey then
        CustomLibrary:Toggle()
    end
end))

-- Make accessible
getgenv().CustomLibrary = CustomLibrary

return CustomLibrary
